# TODO - 31 de Diciembre 2025

## ‚úÖ COMPLETADO (5 Enero 2026): Arquitectura Modular WhatsApp QR Authorization

### Contexto
El m√≥dulo `whatsappQrAuthorization` ha sido completamente refactorizado siguiendo la arquitectura can√≥nica del proyecto (services ‚Üí controllers ‚Üí routes).

### Tareas Completadas

#### 1. Correcci√≥n de Arquitectura QR Authorization ‚úÖ
- **Problema inicial**: Import roto `require('../services/qrAuthorizationService')` - archivo no exist√≠a
- **Soluci√≥n implementada**: Crear m√≥dulo can√≥nico completo en `src/modules/whatsappQrAuthorization/`
- **Estructura final**:
  ```
  src/modules/whatsappQrAuthorization/
  ‚îú‚îÄ‚îÄ services/
  ‚îÇ   ‚îî‚îÄ‚îÄ qrAuthorizationService.js      (L√≥gica de negocio)
  ‚îî‚îÄ‚îÄ controllers/
      ‚îú‚îÄ‚îÄ qrAuthorizationController.js   (Admin endpoints HTTP)
      ‚îî‚îÄ‚îÄ whatsappQrController.js        (WhatsApp session HTTP)
  
  src/routes/
  ‚îú‚îÄ‚îÄ qrAuthorizationRoutes.js          (Admin routes - PENDIENTE)
  ‚îî‚îÄ‚îÄ whatsappQrProxy.js                (WhatsApp routes - Router fino)
  ```

#### 2. Refactor Estructural del Flujo WhatsApp QR ‚úÖ
- **Antes**: `whatsappQrProxy.js` con 311 l√≠neas de l√≥gica HTTP inline
- **Despu√©s**: Router fino de 37 l√≠neas que delega al controller
- **Cambios realizados**:
  - Toda la l√≥gica HTTP movida a `whatsappQrController.js`
  - Validaci√≥n de `clienteId`
  - Autorizaci√≥n con `qrAuthService.isAuthorized()`
  - Orquestaci√≥n de `sessionManagerClient.getSession()` y `requestQR()`
  - Switch de estados (`session.status`)
  - Manejo de errores tipados (`SessionNotFoundError`, etc.)
  - Respuestas HTTP con c√≥digos apropiados
- **Router actual**:
  ```javascript
  router.get('/:clienteId/status', whatsappQrController.getWhatsappSessionStatus);
  router.get('/:clienteId/qr', whatsappQrController.getWhatsappQr);
  ```

#### 3. Servicios Estabilizados ‚úÖ
- **qrAuthorizationService.js**:
  - M√©todos: `registerQrSession`, `authorizeQrSession`, `revokeQrSession`, `getQrSession`, `isAuthorized`
  - Estados: `PENDING`, `AUTHORIZED`, `REVOKED`, `NOT_FOUND`
  - Almacenamiento: Map en memoria (listo para migrar a MySQL)
  - Zero dependencias HTTP
  
- **whatsappQrController.js**:
  - `getWhatsappSessionStatus(req, res)` - Orquesta `getSession()`
  - `getWhatsappQr(req, res)` - Verifica autorizaci√≥n + orquesta `getSession()` + `requestQR()`
  - Importa `sessionManagerClient`, enums y errores tipados
  - Importa `qrAuthorizationService` para verificaci√≥n
  - Zero l√≥gica de negocio (delega al service)

#### 4. Commits y Deploy ‚úÖ
- Commits realizados en rama `feature/central-hub-session-manager`
- Push exitoso: `git push origin feature/central-hub-session-manager`
- C√≥digo verificado: `node src/index.js` arranca sin errores

#### 5. Documentaci√≥n ‚úÖ
- **Archivo**: `docs/WHATSAPP_QR_AUTHORIZATION_MODULE.md` (535 l√≠neas)
- Contiene: estructura completa, m√©todos, endpoints, ejemplos de uso, arquitectura, plan de migraci√≥n DB

### Comportamiento Actual del Sistema

**Endpoints operativos**:
```
GET /api/whatsapp/:clienteId/status  ‚Üí Obtiene estado sesi√≥n WhatsApp
GET /api/whatsapp/:clienteId/qr      ‚Üí Genera/devuelve c√≥digo QR (con verificaci√≥n autorizaci√≥n)
```

**Flujo de autorizaci√≥n**:
1. Usuario solicita QR: `GET /api/whatsapp/:clienteId/qr`
2. `whatsappQrController` verifica: `qrAuthService.isAuthorized(clienteId)`
3. Si no autorizado ‚Üí 403 QR_NOT_AUTHORIZED
4. Si autorizado ‚Üí contin√∫a con `sessionManagerClient.getSession()` ‚Üí `requestQR()`

**Actualmente**: `isAuthorized()` retorna siempre `true` (implementaci√≥n temporal en memoria)

### Pr√≥ximos Pasos (PENDIENTES)

#### A. Persistencia en Base de Datos
- Migrar `qrAuthorizationService.js` de Map a MySQL
- Crear tabla `ll_qr_authorization_sessions`
- Implementar queries SQL para CRUD
- Mantener API del servicio sin cambios

#### B. Endpoints de Administraci√≥n QR (PENDIENTES)
- Crear router: `src/routes/qrAuthorizationRoutes.js`
- Registrar en `src/index.js`: `app.use('/api/qr-auth', ...)`
- Endpoints:
  ```
  POST /api/qr-auth/register    ‚Üí Registrar sesi√≥n QR
  POST /api/qr-auth/authorize   ‚Üí Autorizar sesi√≥n QR
  POST /api/qr-auth/revoke      ‚Üí Revocar sesi√≥n QR
  GET  /api/qr-auth/:sessionId  ‚Üí Consultar estado sesi√≥n
  GET  /api/qr-auth/client/:id  ‚Üí Verificar cliente autorizado
  ```
- Controller `qrAuthorizationController.js` YA existe (267 l√≠neas)

#### C. Tests Automatizados
- Suite de tests para `qrAuthorizationService.js`
- Suite de tests para endpoints QR (`whatsappQrController.js`)
- Validar flujos de autorizaci√≥n/revocaci√≥n

#### D. Autorizaci√≥n Real (Seguridad)
- Implementar flujo admin: registrar ‚Üí autorizar sesi√≥n QR
- Dashboard admin para gestionar autorizaciones
- Logs de auditor√≠a (qui√©n autoriz√≥ qu√© QR)

### Archivos Modificados

**Creados**:
- `src/modules/whatsappQrAuthorization/services/qrAuthorizationService.js` (158 l√≠neas)
- `src/modules/whatsappQrAuthorization/controllers/qrAuthorizationController.js` (267 l√≠neas)
- `src/modules/whatsappQrAuthorization/controllers/whatsappQrController.js` (329 l√≠neas)
- `docs/WHATSAPP_QR_AUTHORIZATION_MODULE.md` (535 l√≠neas)

**Refactorizados**:
- `src/routes/whatsappQrProxy.js` (311 ‚Üí 37 l√≠neas, -274 l√≠neas de l√≥gica HTTP)

**Total**: +1289 l√≠neas nuevas, -274 l√≠neas refactorizadas

### Beneficios Logrados

1. **Arquitectura limpia**: Router ‚Üí Controller ‚Üí Service
2. **Separaci√≥n de responsabilidades**: HTTP vs l√≥gica de negocio
3. **Testabilidad**: Service testeable sin HTTP, controller testeable con mocks
4. **Mantenibilidad**: Cambios en una capa no afectan otras
5. **Escalabilidad**: F√°cil agregar nuevos m√©todos/endpoints
6. **Preparaci√≥n para DB**: Solo requiere modificar service layer

---

## üéØ TAREA PRIORITARIA: Migrar session-manager a whatsapp-web.js

### Problema Actual
- **venom-bot** tiene bug cr√≠tico: loop infinito con tokens viejos, nunca genera QR nuevo
- Se queda en ciclo: "Was disconnected!" ‚Üí "Disconnected by cell phone!" ‚Üí reintenta infinitamente
- Bug en `folderNameToken`: ignora ruta configurada y usa `/src/tokens/` en vez de `/tokens/`

### Soluci√≥n: Migrar a whatsapp-web.js

**Razones:**
1. ‚úÖ M√°s estable y confiable (usado exitosamente en whatsapp-massive-sender)
2. ‚úÖ **PERSISTENCIA DE SESI√ìN**: LocalAuth guarda en disco ‚Üí reconecta autom√°ticamente despu√©s de reinicios
3. ‚úÖ **NO PIDE QR DE NUEVO**: Una vez vinculado, persiste para siempre
4. ‚úÖ Comunidad m√°s grande y activa
5. ‚úÖ Documentaci√≥n superior
6. ‚úÖ No tiene el bug de folderNameToken de venom

**Desventajas aceptables:**
- Usa m√°s memoria (no cr√≠tico en servidor Contabo)
- Arranque un poco m√°s lento (aceptable para servicio que corre 24/7)

---

## üîë OBJETIVO CR√çTICO: Sesi√≥n Persistente

### Requisito del Cliente
**"Una vez que el cliente vincule el QR, ya nunca se desconecte aunque reiniciemos el servidor"**

### C√≥mo lo logra whatsapp-web.js

**LocalAuth Strategy:**
```
Primera vez:
1. Usuario escanea QR
2. WhatsApp Web autentica
3. LocalAuth guarda credenciales en: /tokens/client_51/
   - Default/IndexedDB/
   - Default/Local Storage/
   - session.json (metadatos)
4. ‚úÖ Conectado

Reinicios posteriores (pm2 restart):
1. sessionService.js ejecuta client.initialize()
2. LocalAuth detecta carpeta /tokens/client_51/ existe
3. Lee credenciales guardadas
4. ‚úÖ Reconecta autom√°ticamente SIN pedir QR
5. emit('ready') ‚Üí cliente listo

Cuando S√ç pide QR de nuevo:
- Si borras manualmente /tokens/client_51/
- Si WhatsApp invalida sesi√≥n (cambio de tel√©fono, desvinculaste en app)
- Si archivos de sesi√≥n est√°n corruptos
```

### Ventaja vs venom-bot
- **venom:** Tokens se corrompen f√°cilmente ‚Üí loop infinito (problema actual)
- **whatsapp-web.js:** LocalAuth m√°s robusto ‚Üí reconecta confiablemente

### Pasos de Migraci√≥n

#### 1. Instalar whatsapp-web.js
```bash
cd /root/leadmaster-central-hub
npm install whatsapp-web.js@latest
```

#### 2. Actualizar sessionService.js
**Archivo:** `/root/leadmaster-central-hub/src/modules/session-manager/services/sessionService.js`

**Cambios:**
- Reemplazar `venom-bot` por `whatsapp-web.js`
- Usar `LocalAuth` para gesti√≥n de sesiones
- Mantener misma API externa (clientSessions Map)
- Callbacks: `qr`, `ready`, `authenticated`, `auth_failure`, `disconnected`

**Ejemplo de configuraci√≥n:**
```javascript
const { Client, LocalAuth } = require('whatsapp-web.js');

const client = new Client({
    authStrategy: new LocalAuth({
        clientId: name,
        dataPath: path.join(__dirname, '../../../tokens')
    }),
    puppeteer: {
        headless: true,
        executablePath: '/usr/bin/google-chrome-stable',
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--disable-gpu'
        ]
    }
});

client.on('qr', (qr) => {
    // Generar QR en base64
    const sess = clientSessions.get(clienteId);
    if (sess) {
        sess.qr = qr; // qr es el c√≥digo string
        // Convertir a base64 con librer√≠a qrcode
    }
});

client.on('ready', () => {
    // Cliente listo
    const sess = clientSessions.get(clienteId);
    if (sess) {
        sess.ready = true;
        sess.connecting = false;
    }
});

client.on('authenticated', () => {
    console.log('‚úÖ Autenticado');
});

client.on('auth_failure', (msg) => {
    console.error('‚ùå Error autenticaci√≥n:', msg);
});

client.on('disconnected', (reason) => {
    console.log('‚ö†Ô∏è Desconectado:', reason);
    // Limpiar sesi√≥n
});

await client.initialize();
```

#### 3. Actualizar m√©todos de env√≠o
**Cambio de API:**
- venom: `client.sendText(number, message)`
- whatsapp-web.js: `client.sendMessage(chatId, message)`

**Formato de n√∫mero:**
- venom: `54911XXXXXXXX`
- whatsapp-web.js: `54911XXXXXXXX@c.us`

#### 4. Probar QR Generation
1. Limpiar todos los tokens viejos
2. Iniciar leadmaster-hub
3. Login como Haby
4. Conectar WhatsApp ‚Üí debe mostrar QR
5. Escanear con tu m√≥vil (Alberto)
6. Verificar estabilidad

#### 5. Testing
- [ ] QR se genera correctamente
- [ ] QR se muestra en frontend
- [ ] Escaneo exitoso conecta sesi√≥n
- [ ] **‚úÖ CR√çTICO: Sesi√≥n persiste despu√©s de `pm2 restart leadmaster-hub`**
- [ ] **‚úÖ CR√çTICO: NO pide QR de nuevo al reiniciar (usa tokens guardados)**
- [ ] **‚úÖ CR√çTICO: Reinicio del servidor NO desconecta WhatsApp**
- [ ] Env√≠o de mensaje funciona despu√©s de reinicio
- [ ] Listener recibe mensajes despu√©s de reinicio
- [ ] Verificar `/tokens/client_51/` contiene archivos de sesi√≥n
- [ ] Probar 3 reinicios consecutivos ‚Üí debe reconectar autom√°ticamente cada vez

#### 6. Manejo de Reconexi√≥n Autom√°tica
**Implementar en sessionService.js:**

```javascript
client.on('disconnected', async (reason) => {
    console.log('‚ö†Ô∏è WhatsApp desconectado:', reason);
    const sess = clientSessions.get(clienteId);
    
    if (sess) {
        sess.ready = false;
        sess.connecting = true;
    }
    
    // IMPORTANTE: NO eliminar tokens, dejar que LocalAuth reconecte
    console.log('üîÑ Intentando reconectar autom√°ticamente...');
    
    // Esperar 5 segundos y reintentar
    setTimeout(async () => {
        try {
            await client.initialize();
            console.log('‚úÖ Reconexi√≥n iniciada');
        } catch (error) {
            console.error('‚ùå Error en reconexi√≥n:', error);
        }
    }, 5000);
});

client.on('auth_failure', (msg) => {
    console.error('‚ùå Fallo de autenticaci√≥n:', msg);
    const sess = clientSessions.get(clienteId);
    
    if (sess) {
        sess.ready = false;
        sess.connecting = false;
        // SOLO aqu√≠ limpiamos tokens si falla autenticaci√≥n
        sess.qr = 'REQUERIDO'; // Se√±al para mostrar QR de nuevo
    }
});
```

**Flujo de Reconexi√≥n:**
1. Servidor reinicia ‚Üí `client.initialize()`
2. LocalAuth encuentra tokens ‚Üí reconecta sin QR
3. Si falla conexi√≥n ‚Üí espera 5s ‚Üí reintenta
4. Si falla autenticaci√≥n ‚Üí limpia tokens ‚Üí pide QR nuevo

#### 7. Documentaci√≥n
Actualizar archivos:
- `/root/leadmaster-central-hub/docs/ARQUITECTURA_UNIFICACION.md`
- Agregar nota sobre migraci√≥n de venom a whatsapp-web.js
- Razones t√©cnicas del cambio
- **Garant√≠a de persistencia de sesi√≥n**

### Archivos a Modificar

1. **package.json**
   - Ya tiene whatsapp-web.js? Verificar versi√≥n
   - Si no, agregar: `"whatsapp-web.js": "^1.25.0"` (o latest)

2. **src/modules/session-manager/services/sessionService.js**
   - L√≠neas 1-20: Imports
   - L√≠neas 70-140: Configuraci√≥n de venom ‚Üí reemplazar completamente

3. **src/modules/session-manager/controllers/sessionController.js**
   - Verificar si necesita ajustes en endpoint QR
   - Posiblemente necesite generar base64 desde string QR

### Tiempo Estimado
- Implementaci√≥n: 1-2 horas
- Testing: 30 minutos
- Documentaci√≥n: 15 minutos
- **TOTAL: ~2.5 horas**

### Backup Antes de Empezar
```bash
cd /root/leadmaster-central-hub
git add .
git commit -m "Checkpoint antes de migrar de venom a whatsapp-web.js"
git push
```

### Notas Adicionales
- Mantener venom-bot instalado temporalmente (por si necesitamos rollback)
- Una vez validado funcionamiento, remover venom de dependencies
- El bot-responder puede seguir usando venom (est√° funcionando bien all√≠)

---

## üìå Contexto del Problema de Hoy

**Estado actual (30 Dic 2025):**
- leadmaster-central-hub con venom-bot: NO FUNCIONA (loop infinito)
- whatsapp-massive-sender con whatsapp-web.js: FUNCIONA
- whatsapp-bot-responder con venom-bot: FUNCIONA (pero depende de massive-sender)

**Decisi√≥n:** Migrar leadmaster a whatsapp-web.js para tener sistema estable y aut√≥nomo.

**Usuario:** Alberto (puede testear con su m√≥vil)
**Cliente final:** Haby (conectar√° cuando todo est√© estable)

---

## üìã CHECKLIST FINAL: Validaci√≥n de Persistencia

### Escenario 1: Primera Conexi√≥n
```bash
# Limpiar tokens viejos
rm -rf /root/leadmaster-central-hub/tokens/client_51*

# Iniciar servicio
pm2 restart leadmaster-hub

# En frontend (como Haby):
# 1. Login ‚Üí WhatsApp ‚Üí Ver QR
# 2. Escanear con m√≥vil de Alberto
# 3. ‚úÖ Debe conectar y mostrar "Conectado"
# 4. Verificar: ls -la /root/leadmaster-central-hub/tokens/client_51/
#    Debe tener: Default/, .wwebjs_auth/, session.json
```

### Escenario 2: Reinicio del Servidor (CR√çTICO)
```bash
# Con sesi√≥n activa (despu√©s de Escenario 1)
pm2 restart leadmaster-hub

# Esperar 10-15 segundos
pm2 logs leadmaster-hub --lines 30

# Buscar en logs:
# ‚úÖ "Inicializando WhatsApp para cliente 51"
# ‚úÖ "Cliente 51 WhatsApp listo" (SIN pedir QR)
# ‚ùå NO debe aparecer "qr" o "catchQR"

# En frontend:
# Estado debe cambiar a "Conectado" autom√°ticamente
# NO debe pedir escanear QR de nuevo
```

### Escenario 3: M√∫ltiples Reinicios
```bash
# Probar 5 reinicios consecutivos
for i in {1..5}; do
  echo "Reinicio $i/5"
  pm2 restart leadmaster-hub
  sleep 20
  # Verificar logs - debe reconectar cada vez
done

# ‚úÖ √âXITO: Todas las 5 veces reconecta sin QR
# ‚ùå FALLA: Si pide QR en alg√∫n reinicio ‚Üí bug en LocalAuth
```

### Escenario 4: Env√≠o Despu√©s de Reinicio
```bash
# Despu√©s de Escenario 2 o 3
# En frontend: Campa√±as ‚Üí Crear campa√±a test ‚Üí Enviar 1 mensaje

# ‚úÖ Mensaje debe enviarse exitosamente
# ‚úÖ WhatsApp debe permanecer conectado
```

### Escenario 5: Desconexi√≥n Manual (simular ca√≠da)
```bash
# En el m√≥vil: WhatsApp ‚Üí Dispositivos Vinculados ‚Üí Cerrar sesi√≥n Web

# El servidor debe:
# 1. Detectar desconexi√≥n (event 'disconnected')
# 2. Logs: "WhatsApp desconectado"
# 3. Logs: "Intentando reconectar autom√°ticamente"
# 4. ‚ùå Falla reconexi√≥n (tokens invalidados)
# 5. Frontend debe mostrar "Desconectado - Escanea QR"

# Usuario escanea QR de nuevo ‚Üí debe volver a conectar
```

### ‚úÖ Criterios de Aceptaci√≥n

**DEBE CUMPLIR:**
1. Primera vez: muestra QR, escanea, conecta ‚úÖ
2. Reinicio servidor: reconecta SIN QR ‚úÖ
3. 5 reinicios: reconecta autom√°ticamente cada vez ‚úÖ
4. Env√≠os funcionan despu√©s de reinicio ‚úÖ
5. Tokens persisten en `/tokens/client_51/` ‚úÖ
6. Logs NO muestran "qr" despu√©s de primer escaneo ‚úÖ

**OPCIONAL (mejorado):**
7. Auto-reconexi√≥n despu√©s de desconexi√≥n temporal ‚úÖ
8. Notificaci√≥n en frontend cuando reconecta ‚úÖ

---

## üö® Troubleshooting

### Problema: Sigue pidiendo QR despu√©s de reinicio
**Causa:** LocalAuth no encuentra tokens
**Soluci√≥n:**
```bash
# Verificar que dataPath es correcto
ls -la /root/leadmaster-central-hub/tokens/client_51/

# Verificar permisos
chmod -R 755 /root/leadmaster-central-hub/tokens/
```

### Problema: Loop infinito de reconexi√≥n
**Causa:** Tokens corruptos
**Soluci√≥n:**
```bash
# Limpiar tokens y empezar de nuevo
rm -rf /root/leadmaster-central-hub/tokens/client_51/
pm2 restart leadmaster-hub
# Escanear QR de nuevo
```

### Problema: "Error: Session closed"
**Causa:** WhatsApp detect√≥ uso inusual o m√∫ltiples sesiones
**Soluci√≥n:**
- Esperar 24 horas antes de reconectar
- Usar n√∫mero de tel√©fono diferente para testing
- Verificar que no hay otra sesi√≥n Web activa en el mismo n√∫mero

# GuÃ­a de Arquitectura y MigraciÃ³n

## LeadMaster Workspace (VersiÃ³n Operativa)

---

## 1. Objetivo del documento

Este documento funciona como **guÃ­a Ãºnica de referencia** para:

* Entender la **nueva arquitectura** de LeadMaster
* Guiar la **migraciÃ³n progresiva** desde el estado actual
* Evitar errores operativos (downtime, pÃ©rdida de sesiÃ³n WhatsApp)
* Servir como material de consulta durante el desarrollo con **VS Code + Copilot vÃ­a SSH en Contabo**

No es documentaciÃ³n comercial: es **documentaciÃ³n tÃ©cnica-operativa**.

---

## 2. Principio rector

> **No se rompe lo que funciona.**
> Todo cambio se hace de forma incremental, reversible y validada.

Por eso:

* Se crea un **workspace contenedor**
* Los servicios se desacoplan **uno por uno**
* WhatsApp queda **aislado y protegido**

---

## 3. Arquitectura objetivo (visiÃ³n general)

El sistema LeadMaster se diseÃ±a **desde el inicio como multicliente (multi-tenant)**.

Esto significa que **un mismo workspace y la misma base de cÃ³digo** deben poder operar **para mÃºltiples clientes**, manteniendo **aislamiento lÃ³gico, operativo y de datos** entre ellos.

### Principio multicliente

> Un cliente **nunca** debe poder:
>
> * acceder a datos de otro cliente
> * interferir con sesiones WhatsApp ajenas
> * afectar campaÃ±as, listeners o envÃ­os de terceros

El multicliente **no es una feature**, es una **condiciÃ³n estructural** del sistema.

### Servicios principales

| Servicio               | Rol                        | Alcance multicliente   | Reinicio    |
| ---------------------- | -------------------------- | ---------------------- | ----------- |
| Servicio               | Rol                        | Alcance multicliente   | Reinicio    |
| --------               | -----                      | ---------------------- | ----------  |
| session-manager        | Mantiene conexiÃ³n WhatsApp | 1 sesiÃ³n por cliente   | Excepcional |
| listener               | Mensajes entrantes         | Aislado por cliente    | Permitido   |
| massive-sender         | EnvÃ­os masivos             | Aislado por cliente    | Permitido   |
| leadmaster-central-hub | API, IA, dashboard, lÃ³gica | Multi-tenant           | Permitido   |

ğŸ“Œ **Regla crÃ­tica**:
Existe **un solo `Client()` de whatsapp-web.js por cuenta**, dentro de `session-manager`.

---

## 4. Workspace: estructura oficial

UbicaciÃ³n actual en el servidor:

```
/root/leadmaster-workspace
```

Estructura validada:

```
leadmaster-workspace/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ leadmaster-central-hub/
â”‚   â”œâ”€â”€ session-manager/
â”‚   â”œâ”€â”€ listener/
â”‚   â””â”€â”€ massive-sender/
â”‚
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ logger/
â”‚   â””â”€â”€ types/
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ pm2/
â”‚   â””â”€â”€ deploy/
â”‚
â”œâ”€â”€ ecosystem.config.js
â””â”€â”€ README.md
```

---

## 5. Estado actual de la migraciÃ³n

### PASO 1 â€” Workspace creado âœ…

* Carpeta `leadmaster-workspace` creada
* Estructura base validada
* No se tocÃ³ ningÃºn proyecto activo

### PASO 2 â€” leadmaster-central-hub integrado âœ…

* Copiado dentro de `services/`
* Proyecto original intacto en `/root`
* PM2 sigue apuntando al proyecto viejo

ğŸ‘‰ **Sistema productivo sin cambios**

---

## 6. Estrategia de migraciÃ³n (orden obligatorio)

El orden **no es negociable**, porque protege la sesiÃ³n de WhatsApp **y la separaciÃ³n por cliente**.

### Paso 3 â€” Crear `session-manager` (multicliente)

* Servicio nuevo
* Usa `whatsapp-web.js`
* Mantiene `LocalAuth`
* **Una instancia por cliente** (una cuenta WhatsApp)
* Carpeta de auth separada por `cliente_id`
* Expone API mÃ­nima (`/status`, `/send`)
* Se ejecuta como proceso independiente en PM2

### Paso 4 â€” Conectar API al session-manager

* `leadmaster-central-hub` deja de usar WhatsApp directamente
* Toda comunicaciÃ³n se hace por HTTP
* Cada request incluye `cliente_id`

### Paso 5 â€” Extraer listener (multicliente)

* El listener pasa a su propio proceso
* Opera **por cliente**
* Consume eventos desde el session-manager correspondiente
* Llama a IA / DB / API siempre filtrando por `cliente_id`

### Paso 6 â€” Extraer massive-sender (multicliente)

* Servicio batch
* Opera campaÃ±as **por cliente**
* Usa cola separada por `cliente_id`
* Controla rate-limit, pausas y retries por cliente

---

## 7. PolÃ­tica de reinicios

### session-manager

* âŒ No se reinicia en deploys
* âŒ No se reinicia por cambios de lÃ³gica
* âœ… Se reinicia solo si:

  * WhatsApp queda en estado irrecuperable
  * Se actualiza whatsapp-web.js
  * Hay mantenimiento programado

### Resto de servicios

* Reinicio libre
* Deploys frecuentes
* Sin impacto en WhatsApp

---

## 8. PM2: criterio operativo

Todos los procesos se gestionan desde **un Ãºnico `ecosystem.config.js`** en la raÃ­z del workspace.

Principio:

* Reiniciar **solo el proceso necesario**
* Nunca usar `pm2 restart all` en producciÃ³n

---

## 9. Uso con VS Code + Copilot (SSH)

Este workspace estÃ¡ pensado para:

* Abrirse como carpeta raÃ­z en VS Code
* Permitir que Copilot tenga **contexto completo** del sistema
* Facilitar refactors seguros entre servicios
* Trabajar directamente por SSH en Contabo

Buenas prÃ¡cticas:

* No abrir servicios aislados fuera del workspace
* Mantener contratos visibles para Copilot
* Usar prompts que refieran a otros servicios existentes

---

## 9.1 Rollback y reversibilidad

Cada paso de la migraciÃ³n cumple estas reglas:

* No se elimina cÃ³digo existente
* Se copian proyectos, no se mueven
* PM2 no se modifica hasta validar
* Cada servicio nuevo puede apagarse sin afectar producciÃ³n

Esto garantiza rollback inmediato ante cualquier fallo.

---

## 10. Reglas de oro

1. El sistema es **multicliente por diseÃ±o**, no por parche
2. Nunca mezclar datos entre clientes
3. Nunca mÃ¡s de un `Client()` de WhatsApp por cliente
4. Nunca reiniciar session-manager sin motivo
5. Todo request debe conocer su `cliente_id`
6. Todo cambio debe ser reversible
7. Primero estabilidad, despuÃ©s features

---

## 11. PrÃ³ximos pasos inmediatos

1. Definir contratos HTTP entre servicios (prioridad)
2. Documentar payloads y errores esperados
3. Implementar `session-manager` multicliente
4. Conectar API al session-manager
5. Extraer listener
6. Extraer massive-sender

---

## 12. Nota sobre escalabilidad y lÃ­mites

WhatsApp Web impone lÃ­mites estructurales:

* 1 cuenta WhatsApp = 1 sesiÃ³n activa
* Cada sesiÃ³n consume recursos (Chrome headless)
* El lÃ­mite real no es tÃ©cnico sino operativo (nÃºmeros, bans, costo)

El diseÃ±o multicliente asume **un nÃºmero controlado de clientes**, tÃ­pico de un micro-SaaS B2B.

---

**Este documento se mantiene vivo.**
Debe actualizarse cada vez que se consolida un paso de la migraciÃ³n.
